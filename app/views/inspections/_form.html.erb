<%= simple_form_for(@inspection, multipart: true, html: {id: "file-dropzone"}) do |f| %>
  <%= f.error_notification %>
  <% if f.object.errors["documents"].present? %>
    <p class="alert alert-danger">
      Either Miscellaneous or Email Documents are invalid.
    </p>
  <% end %>
  <fieldset><legend></legend></fieldset>
  <div class="row">
    <div class="col-md-4">
      <%= f.input :name %>
    </div>
    <div class="col-md-4">
      <%= f.association :appointment, :collection => @appointments, :label_method => :appointment_select, label: 'Select Appointment', :prompt => "Select Appointment" %>
    </div>
    <div class="col-md-4 appointment <%= 'hide' unless f.object.appointment_id %>">
      <%= label_tag "Inspector" %>
      <%= text_field_tag "inspector_name", f.object.try(:appointment).try(:inspector).try(:name), class: "appointment inspector form-control", disabled: true %>
    </div>
  </div>
  <div class="appointment_info <%= 'hide' unless f.object.appointment_id %> ">
    <% if f.object.appointment_id %>
      <% @insp_request = f.object.try(:appointment).try(:insp_request) %>
      <%= render 'insp_requests/insp_request_info', object: { insp_request: @insp_request } %>
    <% end %>
  </div>
  <fieldset><legend></legend></fieldset>
  <div class="row">
    <div class="col-md-6">
      <%= f.input :fCondition, as: :select, label: "Foundation Condition", collection: Inspection::FOUNDATION_CONDITION.map{|v| [v, v]}, prompt: "Select Foundation Condition" %>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <%= f.input :nOD, label: "Number Of Days" %>
    </div>
    <div class="col-md-6">
      <%= f.input :nOG, label: "Number Of Guys" %>
    </div>
  </div>
  <fieldset><legend></legend></fieldset>
  <div class="row">
    <div class="col-md-3">
      <%= f.input :completed_appointment_sheet, as: :file, input_html: { accept: ".pdf, .jpg, .png"} %>
    </div>
    <div class="col-md-3 margin-top-25 blue-link">
      <% if f.object.try(:completed_appointment_sheet) %>
        <%= f.object.completed_appointment_sheet_file_name %>
      <% end %>
    </div>
    <div class="col-md-3">
      <%= f.input :client_information_sheet, as: :file, input_html: { accept: ".pdf, .jpg, .png"} %>
    </div>
    <div class="col-md-3 margin-top-25 blue-link">
      <% if f.object.try(:completed_appointment_sheet) %>
        <%= f.object.client_information_sheet_file_name %>
      <% end %>
    </div>
  </div>
  <div class="row">
    <div class="col-md-3">
      <%= f.input :footprint_diagram, as: :file, input_html: { accept: ".pdf, .jpg, .png"} %>
    </div>
    <div class="col-md-3 margin-top-25 blue-link">
      <% if f.object.try(:completed_appointment_sheet) %>
        <%= f.object.footprint_diagram_file_name %>
      <% end %>
    </div>
    <div class="col-md-3">
      <%= f.input :report, as: :file, input_html: { accept: ".pdf, .doc, .docx"}  %>
    </div>
    <div class="col-md-3 margin-top-25 blue-link">
      <% if f.object.try(:completed_appointment_sheet) %>
        <%= f.object.report_file_name %>
      <% end %>
    </div>
  </div>
  <fieldset><legend></legend></fieldset>
  <div class="row">
    <div class="col-md-6">
      <%= f.input :verifiedReport, label: "Verified Report" %>
    </div>
    <div class="col-md-6">
      <%= f.input :verifiedComp, label: "Verified Completed" %>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <%= f.input :repairs, label: "Repairs Needed" %>
    </div>
    <div class="col-md-6">
      <%= f.input :notes %>
    </div>
  </div>
  <fieldset><legend></legend></fieldset>
  <div class="row">
    <%= file_field_tag 'document_attributes[]', multiple: true, id: "documentFile",  accept: ".pdf, .doc, .docx"%>
    <div class="col-md-6 document_preview preview">
      <div class="text-center">No Preview Available.</div>
    </div>
    <% if f.object.documents.present? %>
      <div class="col-md-6">
        <%= label_tag "Uploaded Miscellaneous Documents" %>
        <br/>
        <% f.object.documents.other_documents.each do |document| %>
          <%= link_to document.attachment_file_name, document.attachment.url, class: 'blue-link' %>
          <br/>
        <% end %>
      </div>
    <% end %>
    </div>
  <br/>
  <fieldset><legend></legend></fieldset>
  <div class="row">
    <%= file_field_tag 'email_document_attributes[]', multiple: true, id: "emailDocumentFile",  accept: ".pdf"%>
    <div class="col-md-6 email_preview preview">
      <div class="text-center">No Preview Available.</div>
    </div>
    <% if f.object.documents.present? %>
      <div class="col-md-6">
        <%= label_tag "Uploaded Email Documents" %>
        <br/>
        <% f.object.documents.email_documents.each do |document| %>
          <%= link_to document.attachment_file_name, document.attachment.url, class: 'blue-link' %>
          <br/>
        <% end %>
      </div>
    <% end %>
    </div>
  <br/>
  <div class="actions">
    <%= f.submit "Submit", class: 'btn btn-success submit-button' %>
    <%= link_to 'Back', inspections_path, class: 'btn btn-info' %>
  </div>
<% end %>
<div class="modal modal-details" tabindex="-1" role="dialog" data-keyboard="false">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  $("#inspection_appointment_id").on('change', function(){
    var appointment_id = $(this).val();
    if(appointment_id != ""){
      $.ajax({
        url: '/inspections/' + appointment_id + '/appointment_info',
        type: 'GET'
      });
    }
    else{
      alert("Please select appointment.")
      $(".appointment_info").addClass("hide");
      $(".appointment").addClass("hide");
    }
  });

  loadPreview("documentFile", "document_preview");
  loadPreview("emailDocumentFile", "email_preview");

  function getDocumentImages(type, target){
    var imgName;
    if (type == 'docx' || type == 'doc' || type == 'pdf'){
      imgName = '/assets/' + type + '_icon.png'
    }
    else{
      imgName =  target;
    }
    return imgName;
  }

  function loadPreview(divId, previewClass){
    $("#" + divId).change(function () {
      if (typeof (FileReader) != "undefined") {
        var divPreview = $("." + previewClass);
        divPreview.html("");
        $($(this)[0].files).each(function () {
          var file = $(this);
          var file_name = file[0].name;
          var file_ext = file_name.toLowerCase().split(".").slice(-1)[0];
          var reader = new FileReader();
          reader.onload = function (e) {
            var documentImage = getDocumentImages(file_ext, e.target.result)
            var img = $("<img />");
            img.attr("style", "height:100px;width:100px;border-radius: 8px;").attr('title', file_name);
            if (documentImage){
              img.attr('src', documentImage)
            }
            divPreview.append(img);
          }
          reader.readAsDataURL(file[0]);
        });
      }
      else {
        alert("This browser does not support HTML5 FileReader.");
      }
    });
  }
</script>