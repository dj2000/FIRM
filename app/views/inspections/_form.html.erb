<%= simple_form_for(@inspection, multipart: true, html: {id: "file-dropzone"}) do |f| %>
  <%= f.error_notification %>
  <fieldset><legend></legend></fieldset>
  <div class="row">
    <div class="col-md-4">
      <%= f.input :name %>
    </div>
    <div class="col-md-4">
      <%= f.association :appointment, :collection => @appointments, :label_method => :appointment_select, label: 'Select Appointment', :prompt => "Select Appointment" %>
    </div>
    <div class="col-md-4 appointment <%= 'hide' unless f.object.appointment_id %>">
      <%= label_tag "Inspector" %>
      <%= text_field_tag "inspector_name", f.object.try(:appointment).try(:inspector).try(:name), class: "appointment inspector form-control", disabled: true %>
    </div>
  </div>
  <div class="appointment_info <%= 'hide' unless f.object.appointment_id %> ">
    <% if f.object.appointment_id %>
      <% @insp_request = f.object.try(:appointment).try(:insp_request) %>
      <%= render 'insp_requests/insp_request_info', object: { insp_request: @insp_request } %>
    <% end %>
  </div>
  <fieldset><legend></legend></fieldset>
  <div class="row">
    <div class="col-md-6">
      <%= f.input :fCondition, as: :select, label: "Foundation Condition", collection: Inspection::FOUNDATION_CONDITION.map{|v| [v, v]}, prompt: "Select Foundation Condition" %>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <%= f.input :nOD, label: "Number Of Days" %>
    </div>
    <div class="col-md-6">
      <%= f.input :nOG, label: "Number Of Guys" %>
    </div>
  </div>
  <fieldset><legend></legend></fieldset>
  <div class="row">
    <div class="col-md-3">
      <%= f.input :completed_appointment_sheet, as: :file, input_html: { accept: ".pdf, .jpg, .png"} %>
    </div>
    <div class="col-md-3 margin-top-25 blue-link">
      <% if f.object.try(:completed_appointment_sheet) %>
        <%= f.object.completed_appointment_sheet_file_name %>
      <% end %>
    </div>
    <div class="col-md-3">
      <%= f.input :client_information_sheet, as: :file, input_html: { accept: ".pdf, .jpg, .png"} %>
    </div>
    <div class="col-md-3 margin-top-25 blue-link">
      <% if f.object.try(:completed_appointment_sheet) %>
        <%= f.object.client_information_sheet_file_name %>
      <% end %>
    </div>
  </div>
  <div class="row">
    <div class="col-md-3">
      <%= f.input :footprint_diagram, as: :file, input_html: { accept: ".pdf, .jpg, .png"} %>
    </div>
    <div class="col-md-3 margin-top-25 blue-link">
      <% if f.object.try(:completed_appointment_sheet) %>
        <%= f.object.footprint_diagram_file_name %>
      <% end %>
    </div>
    <div class="col-md-3">
      <%= f.input :report, as: :file, input_html: { accept: ".pdf, .doc, .docx"}  %>
    </div>
    <div class="col-md-3 margin-top-25 blue-link">
      <% if f.object.try(:completed_appointment_sheet) %>
        <%= f.object.report_file_name %>
      <% end %>
    </div>
  </div>
  <fieldset><legend></legend></fieldset>
  <div class="row">
    <div class="col-md-6">
      <%= f.input :verifiedReport, label: "Verified Report" %>
    </div>
    <div class="col-md-6">
      <%= f.input :verifiedComp, label: "Verified Completed" %>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <%= f.input :repairs, label: "Repairs Needed" %>
    </div>
    <div class="col-md-6">
      <%= f.input :notes %>
    </div>
  </div>
  <div class="row">
  <!-- <input type='file' id="imgInp" name="" multiple/> -->
    <%= file_field_tag 'document_attributes[]', multiple: true, id: "imgInp" %>
    <div class="col-md-6 preview">
      <div class="fallback">
        <!-- <input type='file' id="imgInp" name="document_attributes[]" multiple/> -->
      </div>
      <div class="dz-default dz-message">Drop files here or click to upload.</div>
    </div>
    <% if f.object.documents.present? %>
      <div class="col-md-6">
        <%= label_tag "Uploaded Miscellaneous Documents" %>
        <br/>
        <% f.object.documents.each do |document| %>
          <%= image_tag document.attachment.url %>
          <%= link_to document.attachment_file_name, document.attachment.url, class: 'blue-link' %>
          <br/>
        <% end %>
      </div>
    <% end %>
  <br/>
  <div class="actions">
    <%= f.submit "Submit", class: 'btn btn-success submit-button' %>
    <%= link_to 'Back', inspections_path, class: 'btn btn-info' %>
  </div>
<% end %>
<div class="modal modal-details" tabindex="-1" role="dialog" data-keyboard="false">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
  $("#inspection_appointment_id").on('change', function(){
    var appointment_id = $(this).val();
    if(appointment_id != ""){
      $.ajax({
        url: '/inspections/' + appointment_id + '/appointment_info',
        type: 'GET'
      });
    }
    else{
      alert("Please select appointment.")
      $(".appointment_info").addClass("hide");
      $(".appointment").addClass("hide");
    }
  });
  // $("#imgInp").change(function(){
  //       readURL(this);
  //   });
  // function readURL(input) {
  //       console.log(input)
  //       if (input.files && input.files[0]) {
  //           var reader = new FileReader();
            
  //           reader.onload = function (e) {
  //               $('#blah').attr('src', e.target.result);
  //           }
            
  //           reader.readAsDataURL(input.files[0]);
  //       }
  //   }
    
  //   $("#imgInp").change(function(){
  //       readURL(this);
  //   });

  $("#imgInp").change(function () {
        if (typeof (FileReader) != "undefined") {
            var dvPreview = $(".preview");
            dvPreview.html("");
            var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.jpg|.jpeg|.gif|.png|.bmp|.pdf|.doc|.docx)$/;
            $($(this)[0].files).each(function () {
                var file = $(this);
                var file_name = file[0].name.toLowerCase().split(".").slice(-1)[0]

                if (regex.test(file[0].name.toLowerCase())) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var documentImage = getDocumentImages(file_name, e.target.result)
                        console.log("image name is")
                        console.log(file[0].name.toLowerCase().split(".").slice(-1)[0])
                        var img = $("<img />");
                        img.attr("style", "height:100px;width: 100px;border-radius: 8px;");
                        if (documentImage){
                          img.attr('src', documentImage)
                        }
                        
                        dvPreview.append(img);
                    }
                    reader.readAsDataURL(file[0]);
                } else {
                    alert(file[0].name + " is not a valid image file.");
                    dvPreview.html("");
                    return false;
                }
            });
        } else {
            alert("This browser does not support HTML5 FileReader.");
        }
    });

  function getDocumentImages(type, resource){
    var imgName = '';
    if (type == 'docx' || type == 'doc' || type == 'pdf'){
      imgName = '/assets/'+type+'_icon.png'
    }
    else{
      imgName =  resource;
    }
    return imgName;
  }
  
</script>